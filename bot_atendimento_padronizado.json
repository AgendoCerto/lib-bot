{
  "schema": "flowkit/1.0",
  "version": {
    "id": "2.0",
    "status": "development"
  },
  "entries": [
    {
      "kind": "global_start",
      "target": "boas_vindas_hsm"
    }
  ],
  "bot": {
    "id": "atendimento-clinica-padronizado",
    "channels": ["whatsapp"]
  },
  "props": {
    "clinica_nome": "Cl√≠nica Sa√∫de & Bem-Estar",
    "horario_funcionamento": "Segunda a Sexta: 8h √†s 18h",
    "telefone_emergencia": "+55 11 9999-9999",
    "timeout_resposta": 300,
    "max_tentativas_fallback": 3
  },
  "graph": {
    "nodes": [
      {
        "id": "boas_vindas_hsm",
        "kind": "message",
        "title": "Boas-vindas HSM",
        "props": {
          "hsm": {
            "name": "welcome_clinic_template"
          },
          "fallback": {
            "text": "Ol√°! Bem-vindo √† {{props.clinica_nome}}! üè•",
            "max_attempts": 2,
            "timeout": 30
          }
        },
        "x": 100,
        "y": 100,
        "width": 280,
        "height": 80,
        "inputs": [],
          "outputs": ["complete"]
      },
      {
        "id": "delay_inicial",
        "kind": "delay",
        "title": "Delay Inicial",
        "props": {
          "duration": 2000,
          "unit": "milliseconds",
          "reason": "Simular digita√ß√£o"
        },
        "x": 100,
        "y": 220,
        "width": 200,
        "height": 60,
        "inputs": ["trigger"],
        "outputs": ["complete"]
      },
      {
        "id": "apresentacao_imagem",
        "kind": "media",
        "title": "Imagem da Cl√≠nica",
        "props": {
          "type": "image",
          "url": "https://example.com/images/clinica-fachada.jpg",
          "caption": "Bem-vindo √† {{props.clinica_nome}}! üè•\n\nEstamos aqui para cuidar da sua sa√∫de com excel√™ncia.",
          "alt_text": "Fachada da Cl√≠nica Sa√∫de & Bem-Estar",
          "fallback": {
            "text": "üè• Bem-vindo √† {{props.clinica_nome}}!\n\nEstamos aqui para cuidar da sua sa√∫de com excel√™ncia.",
            "reason": "Falha no carregamento da imagem"
          },
          "size_limit": "5MB",
          "dimensions": {
            "max_width": 1920,
            "max_height": 1080
          }
        },
        "x": 100,
        "y": 320,
        "width": 300,
        "height": 120,
        "inputs": ["trigger"],
        "outputs": ["sent", "failed", "timeout"]
      },
      {
        "id": "menu_principal",
        "kind": "buttons",
        "title": "Menu Principal",
        "props": {
          "text": "Ol√°! üëã\n\nComo posso ajud√°-lo hoje?\n\nüìã Escolha uma das op√ß√µes abaixo:",
          "buttons": [
            {
              "id": "btn_agendar",
              "label": "üìÖ Agendar",
              "payload": "agendar",
              "kind": "reply",
              "position": 1
            },
            {
              "id": "btn_agendamentos", 
              "label": "üìã Agendamentos",
              "payload": "agendamentos",
              "kind": "reply",
              "position": 2
            },
            {
              "id": "btn_planos",
              "label": "üõçÔ∏è Planos",
              "payload": "planos",
              "kind": "reply",
              "position": 3
            }
          ],
          "fallback": {
            "text": "Digite:\n1Ô∏è‚É£ Para agendar consulta\n2Ô∏è‚É£ Para ver agendamentos\n3Ô∏è‚É£ Para conhecer planos",
            "timeout": 60,
            "max_attempts": 2
          },
          "header": "Menu de Atendimento",
          "footer": "Responda em at√© 5 minutos"
        },
        "x": 100,
        "y": 480,
        "width": 350,
        "height": 200,
        "inputs": ["trigger"],
        "outputs": ["btn_agendar", "btn_agendamentos", "btn_planos", "timeout", "invalid", "fallback"]
      },
      {
        "id": "especialidades_lista",
        "kind": "listpicker",
        "title": "Lista de Especialidades",
        "props": {
          "text": "üìã Selecione a especialidade para agendar sua consulta:",
          "button_text": "Ver especialidades",
          "sections": [
            {
              "id": "clinica_geral_section",
              "title": "ü©∫ Cl√≠nica Geral",
              "items": [
                {
                  "id": "clinico_geral",
                  "title": "Cl√≠nico Geral",
                  "description": "Consulta geral - 30 min",
                  "payload": "especialidade:clinico_geral",
                  "metadata": {
                    "duracao": 30,
                    "valor": 120.00,
                    "disponivel": true
                  }
                },
                {
                  "id": "checkup",
                  "title": "Check-up Completo", 
                  "description": "Avalia√ß√£o completa - 60 min",
                  "payload": "especialidade:checkup",
                  "metadata": {
                    "duracao": 60,
                    "valor": 250.00,
                    "disponivel": true
                  }
                }
              ]
            },
            {
              "id": "especialidades_section",
              "title": "ü¶∑ Especialidades",
              "items": [
                {
                  "id": "cardiologia",
                  "title": "Cardiologia",
                  "description": "Dr. Jo√£o Silva - 45 min",
                  "payload": "especialidade:cardiologia",
                  "metadata": {
                    "medico": "Dr. Jo√£o Silva",
                    "duracao": 45,
                    "valor": 180.00,
                    "disponivel": true
                  }
                },
                {
                  "id": "dermatologia",
                  "title": "Dermatologia", 
                  "description": "Dra. Maria Santos - 30 min",
                  "payload": "especialidade:dermatologia",
                  "metadata": {
                    "medico": "Dra. Maria Santos",
                    "duracao": 30,
                    "valor": 150.00,
                    "disponivel": false
                  }
                },
                {
                  "id": "ortopedia",
                  "title": "Ortopedia",
                  "description": "Dr. Pedro Costa - 40 min",
                  "payload": "especialidade:ortopedia",
                  "metadata": {
                    "medico": "Dr. Pedro Costa", 
                    "duracao": 40,
                    "valor": 170.00,
                    "disponivel": true
                  }
                }
              ]
            }
          ],
          "fallback": {
            "text": "Digite o n√∫mero da especialidade:\n1. Cl√≠nico Geral\n2. Check-up\n3. Cardiologia\n4. Dermatologia\n5. Ortopedia",
            "parse_mode": "numbered_list",
            "timeout": 120
          },
          "footer": "Escolha uma especialidade",
          "max_selections": 1
        },
        "x": 500,
        "y": 480,
        "width": 400,
        "height": 350,
        "inputs": ["trigger"],
        "outputs": ["clinico_geral", "checkup", "cardiologia", "dermatologia", "ortopedia", "timeout", "invalid", "cancelled"]
      },
      {
        "id": "delay_processamento",
        "kind": "delay",
        "title": "Processando...",
        "props": {
          "duration": 3000,
          "unit": "milliseconds",
          "reason": "Verificando disponibilidade",
          "show_typing": true,
          "message": "üîÑ Verificando disponibilidade..."
        },
        "x": 500,
        "y": 880,
        "width": 250,
        "height": 80,
        "inputs": ["trigger"],
        "outputs": ["complete"]
      },
      {
        "id": "horarios_lista",
        "kind": "listpicker",
        "title": "Sele√ß√£o de Hor√°rios",
        "props": {
          "text": "üïê Hor√°rios dispon√≠veis para {{flow.especialidade_selecionada}}:",
          "button_text": "Ver hor√°rios",
          "sections": [
            {
              "id": "manha_section",
              "title": "üåÖ Manh√£",
              "items": [
                {
                  "id": "08h00",
                  "title": "08:00",
                  "description": "Dispon√≠vel",
                  "payload": "horario:08:00"
                },
                {
                  "id": "09h30", 
                  "title": "09:30",
                  "description": "Dispon√≠vel",
                  "payload": "horario:09:30"
                },
                {
                  "id": "11h00",
                  "title": "11:00", 
                  "description": "Ocupado",
                  "payload": "horario:11:00",
                  "disabled": true
                }
              ]
            },
            {
              "id": "tarde_section",
              "title": "üåá Tarde",
              "items": [
                {
                  "id": "14h00",
                  "title": "14:00",
                  "description": "Dispon√≠vel",
                  "payload": "horario:14:00"
                },
                {
                  "id": "15h30",
                  "title": "15:30",
                  "description": "Dispon√≠vel", 
                  "payload": "horario:15:30"
                },
                {
                  "id": "17h00",
                  "title": "17:00",
                  "description": "√öltima vaga",
                  "payload": "horario:17:00"
                }
              ]
            }
          ],
          "fallback": {
            "text": "Digite o hor√°rio desejado (formato HH:MM):",
            "validation": "^(0[8-9]|1[0-1]|1[4-7]):[0-5][0-9]$",
            "error_message": "Hor√°rio inv√°lido. Use formato HH:MM entre 08:00-11:59 ou 14:00-17:59"
          }
        },
        "x": 500,
        "y": 1000,
        "width": 380,
        "height": 300,
        "inputs": ["trigger"],
        "outputs": ["08h00", "09h30", "11h00", "14h00", "15h30", "17h00", "timeout", "invalid", "cancelled"]
      },
      {
        "id": "agendamento_confirmacao",
        "kind": "confirm",
        "title": "Confirma√ß√£o de Agendamento",
        "props": {
          "title": "üìÖ Confirmar agendamento?",
          "description": "Confirme os dados do seu agendamento antes de prosseguir.",
          "yes": {
            "text": "‚úÖ Confirmar",
            "payload": "confirmar_agendamento",
            "id": "btn_confirmar"
          },
          "no": {
            "text": "‚ùå Cancelar",
            "payload": "cancelar_agendamento",
            "id": "btn_cancelar"
          },
          "fallback": {
            "text": "Digite 'SIM' para confirmar ou 'N√ÉO' para cancelar:",
            "yes_keywords": ["sim", "s", "yes", "y", "confirmar", "ok"],
            "no_keywords": ["n√£o", "nao", "n", "no", "cancelar"]
          },
          "timeout": 300,
          "header": "Confirma√ß√£o Necess√°ria",
          "footer": "Responda em at√© 5 minutos"
        },
        "x": 950,
        "y": 480,
        "width": 350,
        "height": 180,
        "inputs": ["trigger"],
        "outputs": ["btn_confirmar", "btn_cancelar", "timeout"]
      },
      {
        "id": "delay_processamento_agendamento",
        "kind": "delay",
        "title": "Processando Agendamento",
        "props": {
          "duration": 5000,
          "unit": "milliseconds",
          "reason": "Salvando agendamento no sistema",
          "show_typing": true,
          "message": "üíæ Salvando seu agendamento..."
        },
        "x": 950,
        "y": 700,
        "width": 280,
        "height": 80,
        "inputs": ["trigger"],
        "outputs": ["complete"]
      },
      {
        "id": "comprovante_documento",
        "kind": "media",
        "title": "Envio de Comprovante",
        "props": {
          "type": "document",
          "url": "https://example.com/docs/comprovante-agendamento.pdf",
          "caption": "üìÑ Aqui est√° seu comprovante de agendamento!\n\n‚úÖ Agendamento confirmado\nüìÖ Data: {{flow.data_selecionada}}\nüïê Hor√°rio: {{flow.horario_selecionado}}\nüè• Local: {{props.clinica_nome}}\n\nüí° Chegue 15 minutos antes do hor√°rio.",
          "filename": "comprovante-agendamento-{{user.id}}-{{flow.timestamp}}.pdf",
          "size_limit": "10MB",
          "fallback": {
            "text": "üìÑ Comprovante de Agendamento\n\n‚úÖ Confirmado para {{flow.data_selecionada}} √†s {{flow.horario_selecionado}}\nüè• {{props.clinica_nome}}\n\nüìß Comprovante enviado por email tamb√©m.",
            "reason": "Falha no envio do PDF"
          }
        },
        "x": 950,
        "y": 820,
        "width": 320,
        "height": 140,
        "inputs": ["trigger"],
          "outputs": ["sent", "failed", "timeout"]
      },
      {
        "id": "carousel_planos",
        "kind": "carousel",
        "title": "Carrossel de Planos",
        "props": {
          "text": "üõçÔ∏è Conhe√ßa nossos planos e servi√ßos especiais:",
          "cards": [
            {
              "id": "plano_basico",
              "title": "Plano B√°sico",
              "description": "Consultas mensais + exames b√°sicos\n\n‚úÖ 2 consultas/m√™s\n‚úÖ Exames laboratoriais\n‚úÖ Desconto em medicamentos",
              "media_url": "https://example.com/images/plano-basico.jpg",
              "price": "R$ 89,90/m√™s",
              "buttons": [
                {
                  "id": "contratar_basico",
                  "label": "üí∞ Contratar",
                  "payload": "contratar:basico",
                  "kind": "reply"
                },
                {
                  "id": "info_basico",
                  "label": "‚ÑπÔ∏è Saiba mais",
                  "payload": "info:basico", 
                  "kind": "reply"
                }
              ],
              "metadata": {
                "consultas_mes": 2,
                "categoria": "basico",
                "promocao": false
              }
            },
            {
              "id": "plano_premium",
              "title": "Plano Premium",
              "description": "Consultas ilimitadas + exames + especialistas\n\n‚úÖ Consultas ilimitadas\n‚úÖ Todos os exames\n‚úÖ Especialistas inclusos\n‚úÖ Telemedicina",
              "media_url": "https://example.com/images/plano-premium.jpg",
              "price": "R$ 159,90/m√™s",
              "buttons": [
                {
                  "id": "contratar_premium",
                  "label": "üíé Contratar",
                  "payload": "contratar:premium",
                  "kind": "reply"
                },
                {
                  "id": "beneficios_premium",
                  "label": "üìã Benef√≠cios",
                  "payload": "beneficios:premium",
                  "kind": "reply"
                }
              ],
              "metadata": {
                "consultas_mes": -1,
                "categoria": "premium", 
                "promocao": true,
                "desconto": 20
              }
            }
          ],
          "fallback": {
            "text": "üìã Nossos Planos:\n\n1Ô∏è‚É£ B√°sico - R$ 89,90/m√™s\n2Ô∏è‚É£ Premium - R$ 159,90/m√™s\n\nDigite o n√∫mero do plano de interesse:",
            "parse_mode": "numbered_list"
          },
          "layout": "horizontal",
          "max_cards_display": 3
        },
        "x": 100,
        "y": 720,
        "width": 450,
        "height": 300,
        "inputs": ["trigger"],
        "outputs": ["contratar_basico", "info_basico", "contratar_premium", "beneficios_premium", "timeout", "invalid"]
      },
      {
        "id": "meus_agendamentos",
        "kind": "message",
        "title": "Meus Agendamentos",
        "props": {
          "text": "üìã Seus agendamentos, {{user.name}}:\n\n{{#each user.agendamentos}}\nüìÖ {{data}} √†s {{horario}}\nü©∫ {{especialidade}}\nüë®‚Äç‚öïÔ∏è {{medico}}\nüìç {{local}}\n{{#if status}}‚ö†Ô∏è Status: {{status}}{{/if}}\n{{#unless @last}}---{{/unless}}\n{{/each}}\n\nüí° Para remarcar ou cancelar, entre em contato: {{props.telefone_emergencia}}",
          "fallback": {
            "text": "üìã Voc√™ n√£o possui agendamentos no momento.\n\nüìÖ Gostaria de agendar uma consulta?",
            "condition": "user.agendamentos.length == 0"
          },
          "parse_mode": "markdown"
        },
        "x": 100,
        "y": 1080,
        "width": 380,
        "height": 120,
        "inputs": ["trigger"],
          "outputs": ["complete"]
      },
      {
        "id": "informacoes_clinica",
        "kind": "buttons",
        "title": "Informa√ß√µes da Cl√≠nica", 
        "props": {
          "text": "‚ÑπÔ∏è {{props.clinica_nome}}\n\nüïê Hor√°rio de funcionamento:\n{{props.horario_funcionamento}}\n\nüìû Contato de emerg√™ncia:\n{{props.telefone_emergencia}}\n\nüìç Endere√ßo:\nAv. Sa√∫de, 123 - Centro\nS√£o Paulo - SP\nCEP: 01234-567\n\nO que voc√™ gostaria de saber?",
          "buttons": [
            {
              "id": "btn_localizacao",
              "label": "üìç Como chegar",
              "payload": "localizacao",
              "kind": "reply",
              "position": 1
            },
            {
              "id": "btn_site",
              "label": "üåê Site",
              "kind": "url",
              "url": "https://clinicasaude.com.br",
              "position": 2
            },
            {
              "id": "btn_ligar",
              "label": "üìû Ligar agora",
              "kind": "call",
              "payload": "+5511999999999",
              "position": 3
            }
          ],
          "header": "Informa√ß√µes Gerais",
          "footer": "Estamos aqui para ajudar",
          "fallback": {
            "text": "Digite:\n1Ô∏è‚É£ Para localiza√ß√£o\n2Ô∏è‚É£ Para visitar o site\n3Ô∏è‚É£ Para ligar diretamente"
          }
        },
        "x": 600,
        "y": 1080,
        "width": 350,
        "height": 180,
        "inputs": ["trigger"],
        "outputs": ["btn_localizacao", "btn_site", "btn_ligar", "timeout", "invalid", "fallback"]
      },
      {
        "id": "timeout_handler",
        "kind": "message",
        "title": "Tratamento de Timeout",
        "props": {
          "text": "‚è∞ Parece que voc√™ ficou um tempo sem responder.\n\nüîÑ Gostaria de:\n‚Ä¢ Continuar de onde parou\n‚Ä¢ Voltar ao menu principal\n‚Ä¢ Falar com atendente\n\nDigite sua escolha ou aguarde para falar com um humano.",
          "parse_mode": "markdown",
          "auto_trigger": {
            "condition": "timeout",
            "delay": 300000
          }
        },
        "x": 1400,
        "y": 300,
        "width": 320,
        "height": 120,
        "inputs": ["timeout"],
          "outputs": ["complete"]
      },
      {
        "id": "fallback_handler",
        "kind": "message",
        "title": "Tratamento de Fallback",
        "props": {
          "text": "ü§ñ Desculpe, n√£o entendi sua resposta.\n\nüí° Algumas dicas:\n‚Ä¢ Use os bot√µes quando dispon√≠veis\n‚Ä¢ Digite n√∫meros para op√ß√µes\n‚Ä¢ Seja claro e objetivo\n\nüîÑ Vamos tentar novamente?",
          "fallback_count": "{{flow.fallback_attempts | default: 0}}",
          "max_attempts": 3,
          "escalation": {
            "trigger_at": 3,
            "action": "transfer_human",
            "message": "Transferindo para atendimento humano..."
          }
        },
        "x": 1400,
        "y": 480,
        "width": 320,
        "height": 140,
        "inputs": ["fallback"],
          "outputs": ["complete"]
      },
      {
        "id": "finalizar_atendimento",
        "kind": "message",
        "title": "Finaliza√ß√£o",
        "props": {
          "text": "Obrigado por escolher a {{props.clinica_nome}}! üôè\n\n‚≠ê Avalie nosso atendimento:\nSua opini√£o √© muito importante!\n\nüíô Cuide bem da sua sa√∫de!\n\n---\nü§ñ Atendimento autom√°tico encerrado\nüìû Para emerg√™ncias: {{props.telefone_emergencia}}",
          "parse_mode": "markdown",
          "rating": {
            "enabled": true,
            "scale": "1-5",
            "question": "Como voc√™ avalia nosso atendimento?"
          }
        },
        "x": 1400,
        "y": 660,
        "width": 320,
        "height": 140,
        "final": true,
        "inputs": ["trigger"],
          "outputs": ["complete"]
      }
    ],
    "edges": [
      {
        "from": "boas_vindas_hsm",
        "to": "delay_inicial",
        "label": "success",
        "guard": "flow.hsm_sent == true",
        "priority": 1
      },
      {
        "from": "boas_vindas_hsm",
        "to": "apresentacao_imagem",
        "label": "fallback",
        "guard": "flow.hsm_sent == false",
        "priority": 2
      },
      {
        "from": "boas_vindas_hsm",
        "to": "timeout_handler",
        "label": "timeout",
        "guard": "flow.timeout == true",
        "priority": 3
      },
      {
        "from": "delay_inicial",
        "to": "apresentacao_imagem",
        "label": "complete"
      },
      {
        "from": "apresentacao_imagem",
        "to": "menu_principal",
        "label": "sent",
        "guard": "flow.media_sent == true"
      },
      {
        "from": "apresentacao_imagem",
        "to": "menu_principal",
        "label": "failed",
        "guard": "flow.media_sent == false"
      },
      {
        "from": "menu_principal",
        "to": "especialidades_lista",
        "label": "btn_agendar",
        "guard": "payload == 'agendar'"
      },
      {
        "from": "menu_principal",
        "to": "meus_agendamentos", 
        "label": "btn_agendamentos",
        "guard": "payload == 'agendamentos'"
      },
      {
        "from": "menu_principal",
        "to": "carousel_planos",
        "label": "btn_planos",
        "guard": "payload == 'planos'"
      },
      {
        "from": "menu_principal",
        "to": "timeout_handler",
        "label": "timeout",
        "guard": "flow.timeout == true"
      },
      {
        "from": "menu_principal",
        "to": "fallback_handler",
        "label": "invalid",
        "guard": "flow.invalid_input == true"
      },
      {
        "from": "especialidades_lista",
        "to": "delay_processamento",
        "label": "especialidade_selected",
        "guard": "flow.especialidade_selected == true"
      },
      {
        "from": "especialidades_lista",
        "to": "timeout_handler",
        "label": "timeout"
      },
      {
        "from": "especialidades_lista",
        "to": "fallback_handler",
        "label": "invalid"
      },
      {
        "from": "delay_processamento",
        "to": "horarios_lista",
        "label": "complete"
      },
      {
        "from": "horarios_lista",
        "to": "agendamento_confirmacao",
        "label": "horario_selected",
        "guard": "flow.horario_selected == true"
      },
      {
        "from": "horarios_lista",
        "to": "timeout_handler",
        "label": "timeout"
      },
      {
        "from": "agendamento_confirmacao",
        "to": "delay_processamento_agendamento",
        "label": "btn_confirmar",
        "guard": "payload == 'confirmar_agendamento'"
      },
      {
        "from": "agendamento_confirmacao",
        "to": "menu_principal",
        "label": "btn_cancelar",
        "guard": "payload == 'cancelar_agendamento'"
      },
      {
        "from": "agendamento_confirmacao",
        "to": "timeout_handler",
        "label": "timeout"
      },
      {
        "from": "delay_processamento_agendamento",
        "to": "comprovante_documento",
        "label": "complete"
      },
      {
        "from": "comprovante_documento",
        "to": "finalizar_atendimento",
        "label": "sent"
      },
      {
        "from": "comprovante_documento",
        "to": "finalizar_atendimento",
        "label": "failed"
      },
      {
        "from": "carousel_planos",
        "to": "finalizar_atendimento",
        "label": "plano_selected"
      },
      {
        "from": "carousel_planos",
        "to": "timeout_handler",
        "label": "timeout"
      },
      {
        "from": "meus_agendamentos",
        "to": "finalizar_atendimento",
        "label": "complete"
      },
      {
        "from": "informacoes_clinica",
        "to": "finalizar_atendimento",
        "label": "btn_localizacao"
      },
      {
        "from": "informacoes_clinica",
        "to": "finalizar_atendimento",
        "label": "btn_site"
      },
      {
        "from": "informacoes_clinica",
        "to": "finalizar_atendimento",
        "label": "btn_ligar"
      },
      {
        "from": "timeout_handler",
        "to": "menu_principal",
        "label": "menu",
        "guard": "payload == 'menu'"
      },
      {
        "from": "timeout_handler",
        "to": "finalizar_atendimento",
        "label": "human",
        "guard": "payload == 'human'"
      },
      {
        "from": "timeout_handler",
        "to": "finalizar_atendimento",
        "label": "timeout_final"
      },
      {
        "from": "fallback_handler",
        "to": "menu_principal",
        "label": "retry",
        "guard": "flow.fallback_attempts < 3"
      },
      {
        "from": "fallback_handler",
        "to": "finalizar_atendimento",
        "label": "escalate",
        "guard": "flow.fallback_attempts >= 3"
      }
    ]
  }
}